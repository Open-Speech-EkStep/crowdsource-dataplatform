version: 2
jobs:
    build:
        docker:
            - image: circleci/node:13.4
        steps:
            - checkout
            - run:
                name: install-dependencies
                command: npm install
            - run:
                name: tests
                command: npm test
            
            - run:
                name: Deploy in test env
                command: |
                  echo ${GOOGLE_AUTH} > ${HOME}/gcp-key.json
                  gcloud auth activate-service-account --key-file ${HOME}/gcp-key.json
                  gcloud --quiet config set project ${GCP_PROJECT}

                  gcloud app deploy ~/crowdsource-dataplatform/app.yaml

                  rm ${HOME}/gcp-key.json
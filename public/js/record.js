const speakerDetailsKey="speakerDetails",sentencesKey="sentences",currentIndexKey="currentIndex",skipCountKey="skipCount",countKey="count",initialize=()=>{const e=crowdSource.sentences,o=document.getElementById("currentSentenceLbl"),t=document.getElementById("totalSentencesLbl"),n=document.getElementById("sentenceLbl"),s=$("#sentenceLbl"),a=$("#time-progress"),r=$("#time-value"),d=$("#graphbar"),i=$("#startRecord"),c=$("#startRecordRow"),l=$("#stopRecord"),u=$("#reRecord"),m=$("#visualizer"),g=$("#player"),p=$("#nextBtn"),h=p.parent(),C=$("#get-started"),y=$("#skipBtn"),v=$("#recording-sign"),w=$(".progress-bar"),S=$("#page-content"),b=$("#audio-small-error"),f=Number(localStorage.getItem(currentIndexKey)),I=Number(localStorage.getItem(skipCountKey)),k=e.length;let x=f<0?0:f>k-1?k-1:f,T=I<0?0:I>k-1?k-1:I;const N=$("footer"),K=["Letâ€™s get started","","We know you can do more! ","","","You are halfway there. Keep going!","","Just few more steps to go!","","Nine dead, one more to go!","Yay! Done & Dusted!"];h.tooltip({container:"body",placement:screen.availWidth>900?"right":"bottom"});const B=(e,o,t)=>{e.addClass(`animated ${o}`),e.on("animationend",function(){e.removeClass(`animated ${o}`),e.off("animationend"),"function"==typeof t&&t()})},D=e=>{w.width(10*e+"%"),w.prop("aria-valuenow",e)},H=o=>{n.innerText=e[o].sentence,B(s,"lightSpeedIn"),x&&D(x)},R=e=>o.innerText=e,O=e=>{const o=6*(crowdSource.count+e-T),t=1800-o,n=Math.floor(t/60),s=t%60;r.text(`${n}m ${s}s`);const a=42/1800*o;d.height(a+"em")},P=new Notyf({position:{x:"center",y:"top"},types:[{type:"success",className:"fnt-1-5"},{type:"error",duration:3500,className:"fnt-1-5"}]});let W,A,L,j;(()=>{const e=N.outerHeight(),o=a.css("bottom");Number(o.substring(0,o.length-2))&&a.css("bottom",e+"px")})(),H(x),R(x+1),(e=>t.innerText=e)(k),O(x),i.add(u).on("click",()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>{C.hide(),c.addClass("d-none"),l.removeClass("d-none"),v.removeClass("d-none"),u.addClass("d-none"),p.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.removeClass("d-none"),h.tooltip("disable"),b.addClass("d-none"),W=e;const o=new(window.AudioContext||window.webkitAudioContext),t=o.createAnalyser();(L=o.createMediaStreamSource(e)).connect(t),function(e,o){const t=e.getContext("2d"),n=o.frequencyBinCount,s=new Uint8Array(n);WIDTH=e.width,HEIGHT=e.height,function a(){requestAnimationFrame(a);o.getByteTimeDomainData(s);t.fillStyle="rgb(255, 255, 255, 0.8)";t.fillRect(0,0,WIDTH,HEIGHT);t.lineWidth=2;t.strokeStyle="rgb(0,123,255)";t.beginPath();const r=1*WIDTH/n;let d=0;for(let e=0;e<n;e++){let o=s[e]/128,n=o*HEIGHT/2;0===e?t.moveTo(d,n):t.lineTo(d,n),d+=r}t.lineTo(e.width,e.height/2);t.stroke()}()}(visualizer,t),(A=new Recorder(L,{numChannels:2})).record(),j=setTimeout(()=>{l.click()},3e4)}).catch(e=>{console.log(e),P.error("Sorry !!! We could not get access to your audio input device. Make sure you have given microphone access permission"),c.removeClass("d-none"),l.addClass("d-none"),p.addClass("d-none"),u.addClass("d-none"),v.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.addClass("d-none"),b.addClass("d-none")})}),l.on("click",()=>{clearTimeout(j),l.addClass("d-none"),p.removeClass("d-none"),u.removeClass("d-none"),v.addClass("d-none"),c.addClass("d-none"),g.removeClass("d-none"),m.addClass("d-none"),A.stop(),W.getAudioTracks()[0].stop(),A.exportWAV(e=>{const o=(window.URL||window.webkitURL).createObjectURL(e);crowdSource.audioBlob=e,g.prop("src",o),g.on("loadedmetadata",()=>{(e=>{e<2?(h.tooltip("enable"),p.prop("disabled",!0).addClass("point-none"),b.removeClass("d-none")):(h.tooltip("disable"),p.removeAttr("disabled").removeClass("point-none"),b.addClass("d-none"))})(g[0].duration)})}),x==k-1&&C.text(K[k]).show()}),p.add(y).on("click",e=>{"nextBtn"===e.target.id?(!function(){const e=new FormData;e.append("audio_data",crowdSource.audioBlob),e.append("speakerDetails",localStorage.getItem(speakerDetailsKey)),e.append("sentenceId",crowdSource.sentences[x].sentenceId),fetch("/upload",{method:"POST",body:e}).then(e=>e.json()).then(e=>{}).catch(e=>{console.log(e)})}(),O(x+1)):"skipBtn"===e.target.id&&(T++,localStorage.setItem(skipCountKey,T),y.addClass("d-none")),x==k-1?(y.addClass("d-none"),x++,B(S,"zoomOut",()=>S.addClass("d-none")),D(x),localStorage.removeItem("sentences"),localStorage.setItem(currentIndexKey,x),P.success("Congratulations!!! You have completed this batch of sentences"),setTimeout(()=>{location.href="/thank-you"},2500)):x<k-1&&(H(++x),R(x+1),C.text(K[x]),localStorage.setItem(currentIndexKey,x),y.removeClass("d-none")),g.addClass("d-none"),g.trigger("pause"),p.addClass("d-none"),u.addClass("d-none"),c.removeClass("d-none")})},isScreenRotated=()=>{const e=(screen.orientation||{}).type||screen.mozOrientation||screen.msOrientation,o=innerWidth,t=innerHeight;if(("landscape-primary"===e||"landscape-secondary"===e)&&t<600&&t<o)return!0;if(void 0===e){const e=(screen.orientation||{}).angle;return 90===e||-90===e}return!1},adjustTimeProgressBarPosition=()=>{const e=$("#time-progress"),o=e.prev(),t=$("#graphcontainer");(isScreenRotated()||innerWidth<600)&&(e.removeClass("position-fixed text-center").addClass("position-relative text-right"),t.removeClass("mx-auto").addClass("ml-auto"),o.removeClass("mb-5"))};$(document).ready(()=>{window.crowdSource={};const e=$("#instructionsModal"),o=$("#errorModal"),t=$("#loader"),n=$("#page-content"),s=$("#nav-user"),a=s.find("#nav-username");try{screen.orientation.onchange=adjustTimeProgressBarPosition,adjustTimeProgressBarPosition()}catch(e){console.log(e)}try{const r=localStorage.getItem(speakerDetailsKey),d=JSON.parse(r),i=localStorage.getItem("sentences"),c=JSON.parse(i),l=Number(localStorage.getItem("count"));if(e.on("hidden.bs.modal",function(e){n.removeClass("d-none")}),o.on("show.bs.modal",function(o){e.modal("hide")}),o.on("hidden.bs.modal",function(e){location.href="/#speaker-details"}),!d)return void(location.href="/#speaker-details");d.userName&&(s.removeClass("d-none"),a.text(d.userName)),c&&c.userName===d.userName?(crowdSource.sentences=c.sentences,crowdSource.count=l,t.hide(),n.removeClass("d-none"),initialize()):(localStorage.removeItem(currentIndexKey),localStorage.removeItem(skipCountKey),fetch("/sentences",{method:"POST",body:JSON.stringify({userName:d.userName,age:d.age}),headers:{"Content-Type":"application/json"}}).then(e=>{if(e.ok)return e.json();throw Error(e.statusText||"HTTP error")}).then(o=>{e.modal("show"),crowdSource.sentences=o.data,crowdSource.count=Number(o.count),t.hide(),initialize(),localStorage.setItem("sentences",JSON.stringify({userName:d.userName,sentences:o.data})),localStorage.setItem("count",o.count)}).catch(e=>{console.log(e),o.modal("show")}).then(()=>{t.hide()}))}catch(e){console.log(e),o.modal("show")}});
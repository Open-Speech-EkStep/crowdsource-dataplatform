const speakerDetailsKey="speakerDetails",sentencesKey="sentences",currentIndexKey="currentIndex",skipCountKey="skipCount",countKey="count",initialize=()=>{const e=crowdSource.sentences,o=document.getElementById("currentSentenceLbl"),n=document.getElementById("totalSentencesLbl"),t=document.getElementById("sentenceLbl"),a=$("#sentenceLbl"),s=$("#time-progress"),d=$("#time-value"),r=$("#graphbar"),l=$("#startRecord"),c=$("#startRecordRow"),i=$("#stopRecord"),u=$("#reRecord"),m=$("#visualizer"),g=$("#player"),p=$("#nextBtn"),h=p.parent(),C=$("#get-started"),y=$("#skipBtn"),w=$("#recording-row"),b=$("#recording-sign"),f=$(".progress-bar"),v=$("#page-content"),S=$("#audio-small-error"),I=Number(localStorage.getItem(currentIndexKey)),k=Number(localStorage.getItem(skipCountKey)),x=e.length;let T=I<0?0:I>x-1?x-1:I,N=k<0?0:k>x-1?x-1:k;const K=$("footer"),D=["Letâ€™s get started","","We know you can do more! ","","","You are halfway there. Keep going!","","Just few more steps to go!","","Nine dead, one more to go!","Yay! Done & Dusted!"];h.tooltip({container:"body",placement:screen.availWidth>900?"right":"bottom"});const B=(e,o,n)=>{e.addClass(`animated ${o}`),e.on("animationend",function(){e.removeClass(`animated ${o}`),e.off("animationend"),"function"==typeof n&&n()})},H=e=>{f.width(10*e+"%"),f.prop("aria-valuenow",e)},R=o=>{t.innerText=e[o].sentence,B(a,"lightSpeedIn"),T&&H(T)},W=e=>o.innerText=e,A=e=>{const o=6*(crowdSource.count+e-N),n=o>=1800,t=n?o:1800-o,a=Math.floor(t/60),s=t%60;d.text(`${a}m ${s}s`),n&&d.siblings("p").text("We are loving it!");const l=42/1800*o;r.height(l+"em")},L=new Notyf({position:{x:"center",y:"top"},types:[{type:"success",className:"fnt-1-5"},{type:"error",duration:3500,className:"fnt-1-5"}]});let O,E,z,M,J;(()=>{const e=K.outerHeight(),o=s.css("bottom");Number(o.substring(0,o.length-2))&&s.css("bottom",e+"px")})(),R(T),W(T+1),(e=>n.innerText=e)(x),A(T),l.add(u).on("click",()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>{C.hide(),c.addClass("d-none"),i.removeClass("d-none"),w.removeClass("d-none"),b.removeClass("d-none"),u.addClass("d-none"),p.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.removeClass("d-none"),h.tooltip("disable"),S.addClass("d-none"),O=e;const o=window.AudioContext||window.webkitAudioContext;J&&J.close();const n=(J=new o).createAnalyser();(z=J.createMediaStreamSource(e)).connect(n),function(e,o){const n=e.getContext("2d"),t=o.frequencyBinCount,a=new Uint8Array(t);WIDTH=e.width,HEIGHT=e.height,function s(){requestAnimationFrame(s);o.getByteTimeDomainData(a);n.fillStyle="rgb(255, 255, 255, 0.8)";n.fillRect(0,0,WIDTH,HEIGHT);n.lineWidth=2;n.strokeStyle="rgb(0,123,255)";n.beginPath();const d=1*WIDTH/t;let r=0;for(let e=0;e<t;e++){let o=a[e]/128,t=o*HEIGHT/2;0===e?n.moveTo(r,t):n.lineTo(r,t),r+=d}n.lineTo(e.width,e.height/2);n.stroke()}()}(visualizer,n),(E=new Recorder(z,{numChannels:2})).record(),M=setTimeout(()=>{i.click()},3e4)}).catch(e=>{console.log(e),L.error("Sorry !!! We could not get access to your audio input device. Make sure you have given microphone access permission"),c.removeClass("d-none"),i.addClass("d-none"),p.addClass("d-none"),u.addClass("d-none"),b.addClass("d-none"),w.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.addClass("d-none"),S.addClass("d-none")})}),i.on("click",()=>{clearTimeout(M),c.addClass("d-none"),i.addClass("d-none"),p.removeClass("d-none"),u.removeClass("d-none"),b.addClass("d-none"),w.addClass("d-none"),c.addClass("d-none"),g.removeClass("d-none"),m.addClass("d-none"),E.stop(),O.getAudioTracks()[0].stop(),E.exportWAV(e=>{const o=(window.URL||window.webkitURL).createObjectURL(e);crowdSource.audioBlob=e,g.prop("src",o),g.on("loadedmetadata",()=>{(e=>{e<2?(h.tooltip("enable"),p.prop("disabled",!0).addClass("point-none"),S.removeClass("d-none")):(h.tooltip("disable"),p.removeAttr("disabled").removeClass("point-none"),S.addClass("d-none"))})(g[0].duration)})}),T==x-1&&C.text(D[x]).show()});const U=()=>{location.href="/thank-you"};function j(e){const o=new FormData;o.append("audio_data",crowdSource.audioBlob),o.append("speakerDetails",localStorage.getItem(speakerDetailsKey)),o.append("sentenceId",crowdSource.sentences[T].sentenceId),fetch("/upload",{method:"POST",body:o}).then(e=>e.json()).then(e=>{}).catch(e=>{console.log(e)}).then(o=>{e&&"function"==typeof e&&e()})}p.add(y).on("click",e=>{"nextBtn"===e.target.id&&T<x-1?(j(),A(T+1)):"skipBtn"===e.target.id&&(N++,localStorage.setItem(skipCountKey,N),y.addClass("d-none")),T==x-1?("nextBtn"===e.target.id?j(U):setTimeout(U,2500),y.addClass("d-none"),K.addClass("fixed-bottom"),T++,B(v,"zoomOut",()=>v.addClass("d-none")),H(T),localStorage.removeItem("sentences"),localStorage.setItem(currentIndexKey,T),L.success("Congratulations!!! You have completed this batch of sentences"),$("#loader").show()):T<x-1&&(R(++T),W(T+1),C.text(D[T]),localStorage.setItem(currentIndexKey,T),y.removeClass("d-none")),g.addClass("d-none"),g.trigger("pause"),p.addClass("d-none"),u.addClass("d-none"),c.removeClass("d-none")})};$(document).ready(()=>{const e=$("footer");window.crowdSource={};const o=$("#instructionsModal"),n=$("#errorModal"),t=$("#loader"),a=$("#page-content"),s=$("#nav-user"),d=s.find("#nav-username");try{const r=localStorage.getItem(speakerDetailsKey),l=JSON.parse(r),c=localStorage.getItem("sentences"),i=JSON.parse(c),u=Number(localStorage.getItem("count"));if(o.on("hidden.bs.modal",function(){a.removeClass("d-none"),e.removeClass("fixed-bottom"),e.addClass("bottom")}),n.on("show.bs.modal",function(){o.modal("hide")}),n.on("hidden.bs.modal",function(){location.href="/#speaker-details"}),!l)return void(location.href="/#speaker-details");l.userName&&(s.removeClass("d-none"),d.text(l.userName)),i&&i.userName===l.userName&&i.language===l.language?(crowdSource.sentences=i.sentences,crowdSource.count=u,t.hide(),a.removeClass("d-none"),initialize()):(localStorage.removeItem(currentIndexKey),localStorage.removeItem(skipCountKey),fetch("/sentences",{method:"POST",body:JSON.stringify({userName:l.userName,age:l.age,language:l.language}),headers:{"Content-Type":"application/json"}}).then(e=>{if(e.ok)return e.json();throw Error(e.statusText||"HTTP error")}).then(e=>{o.modal("show"),crowdSource.sentences=e.data,crowdSource.count=Number(e.count),t.hide(),initialize(),localStorage.setItem("sentences",JSON.stringify({userName:l.userName,sentences:e.data})),localStorage.setItem("count",e.count)}).catch(e=>{console.log(e),n.modal("show")}).then(()=>{t.hide()}))}catch(e){console.log(e),n.modal("show")}});
const speakerDetailsKey="speakerDetails",sentencesKey="sentences",currentIndexKey="currentIndex",skipCountKey="skipCount",countKey="count",initialize=()=>{const e=crowdSource.sentences,n=document.getElementById("currentSentenceLbl"),o=document.getElementById("totalSentencesLbl"),t=document.getElementById("sentenceLbl"),a=$("#sentenceLbl"),s=$("#time-progress"),r=$("#time-value"),d=$("#graphbar"),i=$("#startRecord"),c=$("#startRecordRow"),l=$("#stopRecord"),u=$("#reRecord"),m=$("#visualizer"),g=$("#player"),p=$("#nextBtn"),h=p.parent(),C=$("#get-started"),y=$("#skipBtn"),w=$("#recording-sign"),S=$(".progress-bar"),v=$("#page-content"),f=$("#audio-small-error"),b=Number(localStorage.getItem(currentIndexKey)),I=Number(localStorage.getItem(skipCountKey)),k=e.length;let T=b<0?0:b>k-1?k-1:b,x=I<0?0:I>k-1?k-1:I;const N=$("footer"),B=["Letâ€™s get started","","We know you can do more! ","","","You are halfway there. Keep going!","","Just few more steps to go!","","Nine dead, one more to go!","Yay! Done & Dusted!"];h.tooltip({container:"body",placement:screen.availWidth>900?"right":"bottom"});const K=(e,n,o)=>{e.addClass(`animated ${n}`),e.on("animationend",function(){e.removeClass(`animated ${n}`),e.off("animationend"),"function"==typeof o&&o()})},D=e=>{S.width(10*e+"%"),S.prop("aria-valuenow",e)},H=n=>{t.innerText=e[n].sentence,K(a,"lightSpeedIn"),T&&D(T)},R=e=>n.innerText=e,O=e=>{const n=6*(crowdSource.count+e-x),o=n>=1800,t=o?n:1800-n,a=Math.floor(t/60),s=t%60;r.text(`${a}m ${s}s`),o&&r.siblings("p").text("We are loving it!");const i=42/1800*n;d.height(i+"em")},P=new Notyf({position:{x:"center",y:"top"},types:[{type:"success",className:"fnt-1-5"},{type:"error",duration:3500,className:"fnt-1-5"}]});let W,A,L,j,z;(()=>{const e=N.outerHeight(),n=s.css("bottom");Number(n.substring(0,n.length-2))&&s.css("bottom",e+"px")})(),H(T),R(T+1),(e=>o.innerText=e)(k),O(T),i.add(u).on("click",()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>{C.hide(),c.addClass("d-none"),l.removeClass("d-none"),w.removeClass("d-none"),u.addClass("d-none"),p.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.removeClass("d-none"),h.tooltip("disable"),f.addClass("d-none"),W=e;const n=window.AudioContext||window.webkitAudioContext;z&&z.close();const o=(z=new n).createAnalyser();(L=z.createMediaStreamSource(e)).connect(o),function(e,n){const o=e.getContext("2d"),t=n.frequencyBinCount,a=new Uint8Array(t);WIDTH=e.width,HEIGHT=e.height,function s(){requestAnimationFrame(s);n.getByteTimeDomainData(a);o.fillStyle="rgb(255, 255, 255, 0.8)";o.fillRect(0,0,WIDTH,HEIGHT);o.lineWidth=2;o.strokeStyle="rgb(0,123,255)";o.beginPath();const r=1*WIDTH/t;let d=0;for(let e=0;e<t;e++){let n=a[e]/128,t=n*HEIGHT/2;0===e?o.moveTo(d,t):o.lineTo(d,t),d+=r}o.lineTo(e.width,e.height/2);o.stroke()}()}(visualizer,o),(A=new Recorder(L,{numChannels:2})).record(),j=setTimeout(()=>{l.click()},3e4)}).catch(e=>{console.log(e),P.error("Sorry !!! We could not get access to your audio input device. Make sure you have given microphone access permission"),c.removeClass("d-none"),l.addClass("d-none"),p.addClass("d-none"),u.addClass("d-none"),w.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.addClass("d-none"),f.addClass("d-none")})}),l.on("click",()=>{clearTimeout(j),l.addClass("d-none"),p.removeClass("d-none"),u.removeClass("d-none"),w.addClass("d-none"),c.addClass("d-none"),g.removeClass("d-none"),m.addClass("d-none"),A.stop(),W.getAudioTracks()[0].stop(),A.exportWAV(e=>{const n=(window.URL||window.webkitURL).createObjectURL(e);crowdSource.audioBlob=e,g.prop("src",n),g.on("loadedmetadata",()=>{(e=>{e<2?(h.tooltip("enable"),p.prop("disabled",!0).addClass("point-none"),f.removeClass("d-none")):(h.tooltip("disable"),p.removeAttr("disabled").removeClass("point-none"),f.addClass("d-none"))})(g[0].duration)})}),T==k-1&&C.text(B[k]).show()});const E=()=>{location.href="/thank-you"};function M(e){const n=new FormData;n.append("audio_data",crowdSource.audioBlob),n.append("speakerDetails",localStorage.getItem(speakerDetailsKey)),n.append("sentenceId",crowdSource.sentences[T].sentenceId),fetch("/upload",{method:"POST",body:n}).then(e=>e.json()).then(e=>{}).catch(e=>{console.log(e)}).then(n=>{e&&"function"==typeof e&&e()})}p.add(y).on("click",e=>{"nextBtn"===e.target.id&&T<k-1?(M(),O(T+1)):"skipBtn"===e.target.id&&(x++,localStorage.setItem(skipCountKey,x),y.addClass("d-none")),T==k-1?("nextBtn"===e.target.id?M(E):setTimeout(E,2500),y.addClass("d-none"),T++,K(v,"zoomOut",()=>v.addClass("d-none")),D(T),localStorage.removeItem("sentences"),localStorage.setItem(currentIndexKey,T),P.success("Congratulations!!! You have completed this batch of sentences"),$("#loader").show()):T<k-1&&(H(++T),R(T+1),C.text(B[T]),localStorage.setItem(currentIndexKey,T),y.removeClass("d-none")),g.addClass("d-none"),g.trigger("pause"),p.addClass("d-none"),u.addClass("d-none"),c.removeClass("d-none")})},isScreenRotated=()=>{const e=(screen.orientation||{}).type||screen.mozOrientation||screen.msOrientation,n=innerWidth,o=innerHeight;if(("landscape-primary"===e||"landscape-secondary"===e)&&o<600&&o<n)return!0;if(void 0===e){const e=(screen.orientation||{}).angle;return 90===e||-90===e}return!1},adjustTimeProgressBarPosition=()=>{$("#time-progress").prev(),$("#graphcontainer"),isScreenRotated()};$(document).ready(()=>{window.crowdSource={};const e=$("#instructionsModal"),n=$("#errorModal"),o=$("#loader"),t=$("#page-content"),a=$("#nav-user"),s=a.find("#nav-username");try{screen.orientation&&screen.orientation.onchange&&(screen.orientation.onchange=adjustTimeProgressBarPosition),adjustTimeProgressBarPosition()}catch(e){console.log(e)}try{const r=localStorage.getItem(speakerDetailsKey),d=JSON.parse(r),i=localStorage.getItem("sentences"),c=JSON.parse(i),l=Number(localStorage.getItem("count"));if(e.on("hidden.bs.modal",function(e){t.removeClass("d-none")}),n.on("show.bs.modal",function(n){e.modal("hide")}),n.on("hidden.bs.modal",function(e){location.href="/#speaker-details"}),!d)return void(location.href="/#speaker-details");d.userName&&(a.removeClass("d-none"),s.text(d.userName)),c&&c.userName===d.userName&&c.language===d.language?(crowdSource.sentences=c.sentences,crowdSource.count=l,o.hide(),t.removeClass("d-none"),initialize()):(localStorage.removeItem(currentIndexKey),localStorage.removeItem(skipCountKey),fetch("/sentences",{method:"POST",body:JSON.stringify({userName:d.userName,age:d.age,language:d.language}),headers:{"Content-Type":"application/json"}}).then(e=>{if(e.ok)return e.json();throw Error(e.statusText||"HTTP error")}).then(n=>{e.modal("show"),crowdSource.sentences=n.data,crowdSource.count=Number(n.count),o.hide(),initialize(),localStorage.setItem("sentences",JSON.stringify({userName:d.userName,sentences:n.data})),localStorage.setItem("count",n.count)}).catch(e=>{console.log(e),n.modal("show")}).then(()=>{o.hide()}))}catch(e){console.log(e),n.modal("show")}});
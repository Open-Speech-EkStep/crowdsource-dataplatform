const speakerDetailsKey="speakerDetails",sentencesKey="sentences",currentIndexKey="currentIndex",skipCountKey="skipCount",countKey="count",initialize=()=>{const e=crowdSource.sentences,o=document.getElementById("currentSentenceLbl"),n=document.getElementById("totalSentencesLbl"),t=document.getElementById("sentenceLbl"),a=$("#sentenceLbl"),s=$("#time-progress"),d=$("#time-value"),r=$("#graphbar"),l=$("#startRecord"),c=$("#startRecordRow"),i=$("#stopRecord"),u=$("#stop-recording-row"),m=$("#reRecord"),g=$("#visualizer"),p=$("#player"),h=$("#nextBtn"),C=h.parent(),y=$("#get-started"),w=$("#skipBtn"),b=$("#recording-row"),v=$("#recording-sign"),f=$(".progress-bar"),S=$("#page-content"),I=$("#audio-small-error"),k=Number(localStorage.getItem(currentIndexKey)),x=Number(localStorage.getItem(skipCountKey)),T=e.length;let N=k<0?0:k>T-1?T-1:k,K=x<0?0:x>T-1?T-1:x;const D=$("footer"),B=["Letâ€™s get started","","We know you can do more! ","","","You are halfway there. Keep going!","","Just few more steps to go!","","Nine dead, one more to go!","Yay! Done & Dusted!"];C.tooltip({container:"body",placement:screen.availWidth>900?"right":"bottom"});const H=(e,o,n)=>{e.addClass(`animated ${o}`),e.on("animationend",function(){e.removeClass(`animated ${o}`),e.off("animationend"),"function"==typeof n&&n()})},R=e=>{f.width(10*e+"%"),f.prop("aria-valuenow",e)},W=o=>{t.innerText=e[o].sentence,H(a,"lightSpeedIn"),N&&R(N)},A=e=>o.innerText=e,L=e=>{const o=6*(crowdSource.count+e-K),n=o>=1800,t=n?o:1800-o,a=Math.floor(t/60),s=t%60;d.text(`${a}m ${s}s`),n&&d.siblings("p").text("We are loving it!");const l=42/1800*o;r.height(l+"em")},O=new Notyf({position:{x:"center",y:"top"},types:[{type:"success",className:"fnt-1-5"},{type:"error",duration:3500,className:"fnt-1-5"}]});let E,z,M,J,U;(()=>{const e=D.outerHeight(),o=s.css("bottom");Number(o.substring(0,o.length-2))&&s.css("bottom",e+"px")})(),W(N),A(N+1),(e=>n.innerText=e)(T),L(N),l.add(m).on("click",()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>{y.hide(),c.addClass("d-none"),u.removeClass("d-none"),i.removeClass("d-none"),b.removeClass("d-none"),v.removeClass("d-none"),m.addClass("d-none"),h.addClass("d-none"),p.addClass("d-none"),p.trigger("pause"),g.removeClass("d-none"),C.tooltip("disable"),I.addClass("d-none"),E=e;const o=window.AudioContext||window.webkitAudioContext;U&&U.close();const n=(U=new o).createAnalyser();(M=U.createMediaStreamSource(e)).connect(n),function(e,o){const n=e.getContext("2d"),t=o.frequencyBinCount,a=new Uint8Array(t);WIDTH=e.width,HEIGHT=e.height,function s(){requestAnimationFrame(s);o.getByteTimeDomainData(a);n.fillStyle="rgb(255, 255, 255, 0.8)";n.fillRect(0,0,WIDTH,HEIGHT);n.lineWidth=2;n.strokeStyle="rgb(0,123,255)";n.beginPath();const d=1*WIDTH/t;let r=0;for(let e=0;e<t;e++){let o=a[e]/128,t=o*HEIGHT/2;0===e?n.moveTo(r,t):n.lineTo(r,t),r+=d}n.lineTo(e.width,e.height/2);n.stroke()}()}(visualizer,n),(z=new Recorder(M,{numChannels:2})).record(),J=setTimeout(()=>{i.click()},3e4)}).catch(e=>{console.log(e),O.error("Sorry !!! We could not get access to your audio input device. Make sure you have given microphone access permission"),c.removeClass("d-none"),u.addClass("d-none"),i.addClass("d-none"),h.addClass("d-none"),m.addClass("d-none"),v.addClass("d-none"),b.addClass("d-none"),p.addClass("d-none"),p.trigger("pause"),g.addClass("d-none"),I.addClass("d-none")})}),i.on("click",()=>{clearTimeout(J),c.addClass("d-none"),i.addClass("d-none"),h.removeClass("d-none"),m.removeClass("d-none"),v.addClass("d-none"),b.addClass("d-none"),c.addClass("d-none"),p.removeClass("d-none"),g.addClass("d-none"),z.stop(),E.getAudioTracks()[0].stop(),z.exportWAV(e=>{const o=(window.URL||window.webkitURL).createObjectURL(e);crowdSource.audioBlob=e,p.prop("src",o),p.on("loadedmetadata",()=>{(e=>{e<2?(C.tooltip("enable"),h.prop("disabled",!0).addClass("point-none"),I.removeClass("d-none")):(C.tooltip("disable"),h.removeAttr("disabled").removeClass("point-none"),I.addClass("d-none"))})(p[0].duration)})}),N==T-1&&y.text(B[T]).show()});const j=()=>{location.href="/thank-you"};function P(e){const o=new FormData;o.append("audio_data",crowdSource.audioBlob),o.append("speakerDetails",localStorage.getItem(speakerDetailsKey)),o.append("sentenceId",crowdSource.sentences[N].sentenceId),fetch("/upload",{method:"POST",body:o}).then(e=>e.json()).then(e=>{}).catch(e=>{console.log(e)}).then(o=>{e&&"function"==typeof e&&e()})}h.add(w).on("click",e=>{"nextBtn"===e.target.id&&N<T-1?(P(),L(N+1)):"skipBtn"===e.target.id&&(K++,localStorage.setItem(skipCountKey,K),w.addClass("d-none")),N==T-1?("nextBtn"===e.target.id?P(j):setTimeout(j,2500),w.addClass("d-none"),D.addClass("fixed-bottom"),N++,H(S,"zoomOut",()=>S.addClass("d-none")),R(N),localStorage.removeItem("sentences"),localStorage.setItem(currentIndexKey,N),O.success("Congratulations!!! You have completed this batch of sentences"),$("#loader").show()):N<T-1&&(W(++N),A(N+1),y.text(B[N]),localStorage.setItem(currentIndexKey,N),w.removeClass("d-none")),p.addClass("d-none"),p.trigger("pause"),h.addClass("d-none"),m.addClass("d-none"),c.removeClass("d-none")})};$(document).ready(()=>{const e=$("footer");window.crowdSource={};const o=$("#instructionsModal"),n=$("#errorModal"),t=$("#loader"),a=$("#page-content"),s=$("#nav-user"),d=s.find("#nav-username");try{const r=localStorage.getItem(speakerDetailsKey),l=JSON.parse(r),c=localStorage.getItem("sentences"),i=JSON.parse(c),u=Number(localStorage.getItem("count"));if(o.on("hidden.bs.modal",function(){a.removeClass("d-none"),e.removeClass("fixed-bottom"),e.addClass("bottom")}),n.on("show.bs.modal",function(){o.modal("hide")}),n.on("hidden.bs.modal",function(){location.href="/#speaker-details"}),!l)return void(location.href="/#speaker-details");l.userName&&(s.removeClass("d-none"),d.text(l.userName)),i&&i.userName===l.userName&&i.language===l.language?(crowdSource.sentences=i.sentences,crowdSource.count=u,t.hide(),a.removeClass("d-none"),initialize()):(localStorage.removeItem(currentIndexKey),localStorage.removeItem(skipCountKey),fetch("/sentences",{method:"POST",body:JSON.stringify({userName:l.userName,age:l.age,language:l.language}),headers:{"Content-Type":"application/json"}}).then(e=>{if(e.ok)return e.json();throw Error(e.statusText||"HTTP error")}).then(e=>{o.modal("show"),crowdSource.sentences=e.data,crowdSource.count=Number(e.count),t.hide(),initialize(),localStorage.setItem("sentences",JSON.stringify({userName:l.userName,sentences:e.data})),localStorage.setItem("count",e.count)}).catch(e=>{console.log(e),n.modal("show")}).then(()=>{t.hide()}))}catch(e){console.log(e),n.modal("show")}});
const speakerDetailsKey="speakerDetails",sentencesKey="sentences",currentIndexKey="currentIndex",skipCountKey="skipCount",countKey="count",initialize=()=>{const e=crowdSource.sentences,o=document.getElementById("currentSentenceLbl"),n=document.getElementById("totalSentencesLbl"),t=document.getElementById("sentenceLbl"),a=$("#sentenceLbl"),s=$("#time-progress"),r=$("#time-value"),d=$("#graphbar"),c=$("#startRecord"),i=$("#startRecordRow"),l=$("#stopRecord"),u=$("#reRecord"),m=$("#visualizer"),g=$("#player"),p=$("#nextBtn"),h=p.parent(),C=$("#get-started"),y=$("#skipBtn"),w=$("#recording-row"),S=$("#recording-sign"),v=$(".progress-bar"),b=$("#page-content"),f=$("#audio-small-error"),I=Number(localStorage.getItem(currentIndexKey)),k=Number(localStorage.getItem(skipCountKey)),T=e.length;let x=I<0?0:I>T-1?T-1:I,N=k<0?0:k>T-1?T-1:k;const K=$("footer"),B=["Letâ€™s get started","","We know you can do more! ","","","You are halfway there. Keep going!","","Just few more steps to go!","","Nine dead, one more to go!","Yay! Done & Dusted!"];h.tooltip({container:"body",placement:screen.availWidth>900?"right":"bottom"});const D=(e,o,n)=>{e.addClass(`animated ${o}`),e.on("animationend",function(){e.removeClass(`animated ${o}`),e.off("animationend"),"function"==typeof n&&n()})},H=e=>{v.width(10*e+"%"),v.prop("aria-valuenow",e)},R=o=>{t.innerText=e[o].sentence,D(a,"lightSpeedIn"),x&&H(x)},W=e=>o.innerText=e,A=e=>{const o=6*(crowdSource.count+e-N),n=o>=1800,t=n?o:1800-o,a=Math.floor(t/60),s=t%60;r.text(`${a}m ${s}s`),n&&r.siblings("p").text("We are loving it!");const c=42/1800*o;d.height(c+"em")},L=new Notyf({position:{x:"center",y:"top"},types:[{type:"success",className:"fnt-1-5"},{type:"error",duration:3500,className:"fnt-1-5"}]});let O,P,E,j,z;(()=>{const e=K.outerHeight(),o=s.css("bottom");Number(o.substring(0,o.length-2))&&s.css("bottom",e+"px")})(),R(x),W(x+1),(e=>n.innerText=e)(T),A(x),c.add(u).on("click",()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>{C.hide(),i.addClass("d-none"),l.removeClass("d-none"),w.removeClass("d-none"),S.removeClass("d-none"),u.addClass("d-none"),p.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.removeClass("d-none"),h.tooltip("disable"),f.addClass("d-none"),O=e;const o=window.AudioContext||window.webkitAudioContext;z&&z.close();const n=(z=new o).createAnalyser();(E=z.createMediaStreamSource(e)).connect(n),function(e,o){const n=e.getContext("2d"),t=o.frequencyBinCount,a=new Uint8Array(t);WIDTH=e.width,HEIGHT=e.height,function s(){requestAnimationFrame(s);o.getByteTimeDomainData(a);n.fillStyle="rgb(255, 255, 255, 0.8)";n.fillRect(0,0,WIDTH,HEIGHT);n.lineWidth=2;n.strokeStyle="rgb(0,123,255)";n.beginPath();const r=1*WIDTH/t;let d=0;for(let e=0;e<t;e++){let o=a[e]/128,t=o*HEIGHT/2;0===e?n.moveTo(d,t):n.lineTo(d,t),d+=r}n.lineTo(e.width,e.height/2);n.stroke()}()}(visualizer,n),(P=new Recorder(E,{numChannels:2})).record(),j=setTimeout(()=>{l.click()},3e4)}).catch(e=>{console.log(e),L.error("Sorry !!! We could not get access to your audio input device. Make sure you have given microphone access permission"),i.removeClass("d-none"),l.addClass("d-none"),p.addClass("d-none"),u.addClass("d-none"),S.addClass("d-none"),w.addClass("d-none"),g.addClass("d-none"),g.trigger("pause"),m.addClass("d-none"),f.addClass("d-none")})}),l.on("click",()=>{clearTimeout(j),l.addClass("d-none"),p.removeClass("d-none"),u.removeClass("d-none"),S.addClass("d-none"),w.addClass("d-none"),i.addClass("d-none"),g.removeClass("d-none"),m.addClass("d-none"),P.stop(),O.getAudioTracks()[0].stop(),P.exportWAV(e=>{const o=(window.URL||window.webkitURL).createObjectURL(e);crowdSource.audioBlob=e,g.prop("src",o),g.on("loadedmetadata",()=>{(e=>{e<2?(h.tooltip("enable"),p.prop("disabled",!0).addClass("point-none"),f.removeClass("d-none")):(h.tooltip("disable"),p.removeAttr("disabled").removeClass("point-none"),f.addClass("d-none"))})(g[0].duration)})}),x==T-1&&C.text(B[T]).show()});const M=()=>{location.href="/thank-you"};function J(e){const o=new FormData;o.append("audio_data",crowdSource.audioBlob),o.append("speakerDetails",localStorage.getItem(speakerDetailsKey)),o.append("sentenceId",crowdSource.sentences[x].sentenceId),fetch("/upload",{method:"POST",body:o}).then(e=>e.json()).then(e=>{}).catch(e=>{console.log(e)}).then(o=>{e&&"function"==typeof e&&e()})}p.add(y).on("click",e=>{"nextBtn"===e.target.id&&x<T-1?(J(),A(x+1)):"skipBtn"===e.target.id&&(N++,localStorage.setItem(skipCountKey,N),y.addClass("d-none")),x==T-1?("nextBtn"===e.target.id?J(M):setTimeout(M,2500),y.addClass("d-none"),x++,D(b,"zoomOut",()=>b.addClass("d-none")),H(x),localStorage.removeItem("sentences"),localStorage.setItem(currentIndexKey,x),L.success("Congratulations!!! You have completed this batch of sentences"),$("#loader").show()):x<T-1&&(R(++x),W(x+1),C.text(B[x]),localStorage.setItem(currentIndexKey,x),y.removeClass("d-none")),g.addClass("d-none"),g.trigger("pause"),p.addClass("d-none"),u.addClass("d-none"),i.removeClass("d-none")})};$(document).ready(()=>{window.crowdSource={};const e=$("#instructionsModal"),o=$("#errorModal"),n=$("#loader"),t=$("#page-content"),a=$("#nav-user"),s=a.find("#nav-username");try{screen.orientation&&screen.orientation.onchange&&(screen.orientation.onchange=adjustTimeProgressBarPosition),adjustTimeProgressBarPosition()}catch(e){console.log(e)}try{const r=localStorage.getItem(speakerDetailsKey),d=JSON.parse(r),c=localStorage.getItem("sentences"),i=JSON.parse(c),l=Number(localStorage.getItem("count"));if(e.on("hidden.bs.modal",function(e){t.removeClass("d-none")}),o.on("show.bs.modal",function(o){e.modal("hide")}),o.on("hidden.bs.modal",function(e){location.href="/#speaker-details"}),!d)return void(location.href="/#speaker-details");d.userName&&(a.removeClass("d-none"),s.text(d.userName)),i&&i.userName===d.userName&&i.language===d.language?(crowdSource.sentences=i.sentences,crowdSource.count=l,n.hide(),t.removeClass("d-none"),initialize()):(localStorage.removeItem(currentIndexKey),localStorage.removeItem(skipCountKey),fetch("/sentences",{method:"POST",body:JSON.stringify({userName:d.userName,age:d.age,language:d.language}),headers:{"Content-Type":"application/json"}}).then(e=>{if(e.ok)return e.json();throw Error(e.statusText||"HTTP error")}).then(o=>{e.modal("show"),crowdSource.sentences=o.data,crowdSource.count=Number(o.count),n.hide(),initialize(),localStorage.setItem("sentences",JSON.stringify({userName:d.userName,sentences:o.data})),localStorage.setItem("count",o.count)}).catch(e=>{console.log(e),o.modal("show")}).then(()=>{n.hide()}))}catch(e){console.log(e),o.modal("show")}});